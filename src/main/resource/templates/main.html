<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorator="layouts/base">
<head>
<meta charset="UTF-8"></meta>
<title>main画面</title>
</head>
<body>
	<div layout:fragment="content">
		<header>
			<div id="example">
				<h1 th:text="${msg}"></h1>
				<p><a href="/userinformation">ユーザー情報の編集</a></p>
			</div>
			<nav>
				<ul>
					<p><a href="/userlist">ユーザー一覧</a></p>
					<form action="/logout" method="POST">
						<p>
							<input type="submit" value="ログアウト"></input>
						</p>
					</form>
				</ul>
			</nav>
		</header>

		<div id="app">
			<input type="hidden" th:value="${username}" v-model="tweetName"/>
			ツイート：<p><textarea cols="30" rows="3" name="tweet" v-model="tweetText">{{ tweetText }}</textarea>
			</p>
			<p>
				<button type="button" class="jsc-tweet" v-on:click="tweet()">ツイート</button>
			</p>

			<div>
				<ul>
					<template v-for="tweet in result.list">
					<h2>{{ tweet.userName }}</h2>
					<p>{{ tweet.contents }}</p>
					</template>
				</ul>
			</div>
			<button v-if="result.existsNextPage" v-on:click="nextPage()" value="もっと見る">もっと見る</button>
		</div>
		<script>
			new Vue({
				el : '#app',
				data : {
					result : {
						list : [],
						existsNextPage : true,
					},
					tweetText : "",
					tweetName : ""
				},
				created : function() {
					var that = this;
					$.ajax({
						type : "GET",
						url : "/tweets",
						dataType : "json",
						success : function(list) {
							// 謌仙粥譎ゅ�ｮ蜃ｦ逅�縺ｨ縺励※繝ｪ繧ｹ繝亥ｽ｢蠑上�ｮ邨先棡繧剃ｻ｣蜈･縺吶ｋ
							// e.g. [{"title": "hoge", "text": "hogehoge"}, ...]
							that.result.list = list.data;
							that.result.currentPageNumber = list.currentPageNumber;
							that.result.existsNextPage = list.existsNextPage;
						}
					});
				},
				methods : {
					nextPage : function() {
						var that = this;
						$.ajax({
							type : "GET",
							url : "/tweets?p=" + (that.result.currentPageNumber+1),
							dataType : "json",
							success : function(list) {
								for (var index in list.data){
									that.result.list.push(list.data[index]);
								}
								that.result.currentPageNumber = list.currentPageNumber;
								that.result.existsNextPage = list.existsNextPage;
							}
						});
					},
					tweet : function() {
						var that = this;
						if (that.tweetText.length > 140) {
							alert("140文字以下でツイートしてください");
							return;
						}
						var data = {
								contents : that.tweetText
						};
						$.ajax({
							type : "POST",
							url : "/tweets",
							contentType : 'application/json',
							data : JSON.stringify(data),
							//dataType : "text",
							success : function(tweetData) {
								var tweet = { "userName" : that.tweetName, "contents" : that.tweetText};
								that.result.list.unshift(tweet);
								that.tweetText = "";
								alert("ツイートしました");
							},
							error : function(xhr, ajaxOption, thrownError) {
								alert("error");
							}
						});
					}
				}
			});
		</script>
	</div>

</body>
</html>